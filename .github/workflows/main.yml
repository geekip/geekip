name: Generate File

on:
  push:
    branches: [main]
  schedule:
    - cron: '0 0 * * *' # æ¯å¤©è¿è¡Œä¸€æ¬¡

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Install xmlstarlet
      run: sudo apt-get install -y xmlstarlet

    - name: Generate a file
      run: |
        set -e

        # å®šä¹‰è¾“å‡ºMarkdownæ–‡ä»¶
        OUTPUT_FILE="README.md"

        # ä½¿ç”¨curlä¸‹è½½RSS XMLæ–‡ä»¶å†…å®¹
        rss_content=$(curl -s "https://blog.yangfei.site/feed/")

        # æ£€æŸ¥æ˜¯å¦æˆåŠŸä¸‹è½½RSSå†…å®¹
        if [ -z "$rss_content" ]; then
          echo "Failed to download RSS content."
          exit 1
        fi

        # ä½¿ç”¨xmlstarletè§£æXMLå¹¶æå–æ–‡ç« æ ‡é¢˜ã€é“¾æ¥åœ°å€ã€å‘å¸ƒæ—¶é—´
        titles=$(echo "$rss_content" | xmlstarlet sel -t -m "//item/title" -v . -n)
        links=$(echo "$rss_content" | xmlstarlet sel -t -m "//item/link" -v . -n)
        pub_dates=$(echo "$rss_content" | xmlstarlet sel -t -m "//item/pubDate" -v . -n)

        # æ£€æŸ¥æ˜¯å¦æˆåŠŸæå–å†…å®¹
        if [ -z "$titles" ] || [ -z "$links" ] || [ -z "$pub_dates" ]; then
          echo "Failed to extract necessary data from RSS feed."
          exit 1
        fi

        # å°†æå–å†…å®¹æŒ‰è¡Œåˆ†å‰²å¹¶æ”¾å…¥æ•°ç»„ä¸­
        IFS=$'\n' read -rd '' -a title_array <<<"$titles"
        IFS=$'\n' read -rd '' -a link_array <<<"$links"
        IFS=$'\n' read -rd '' -a date_array <<<"$pub_dates"

        echo "### Hi there ğŸ‘‹" > "$OUTPUT_FILE"
        echo "I'm a product manager and a hobbyist developer." >> "$OUTPUT_FILE"
        echo "### Latest blog posts" >> "$OUTPUT_FILE"

        # å°†å†…å®¹æ ¼å¼åŒ–å¹¶å†™å…¥è¾“å‡ºæ–‡ä»¶
        for i in "${!title_array[@]}"; do
          # å°†æ—¥æœŸæ ¼å¼åŒ–ä¸º[Y-m-d]
          formatted_date=$(date -d "${date_array[$i]}" +"[%Y-%m-%d]")
          echo "$formatted_date - [${title_array[$i]}](${link_array[$i]})" >> "$OUTPUT_FILE"
        done

    - name: Commit and push changes
      run: |
        set -e
        git config --global user.email "mail@yangfei.site"
        git config --global user.name "geekip"

        if [ -n "$(git status --porcelain)" ]; then
          git add README.md
          git commit -m "Update README with latest blog posts"
          git push
        else
          echo "No changes to commit."
        fi
